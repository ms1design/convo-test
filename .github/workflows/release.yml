name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to set (optional). If not provided, the patch version will be incremented.'
        required: false
        default: ''
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  validate:
    name: Validate HACS & hassfest
    runs-on: ubuntu-latest
    if: ${{ github.actor != 'github-actions[bot]' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv and persist PATH
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Create virtual environment (uv venv)
        run: uv venv

      - name: Install test deps
        run: uv pip install -r requirements.txt

      # - name: HACS validation
      #   uses: hacs/action@main
      #   with:
      #     category: integration

      # - name: Hassfest validation
      #   uses: home-assistant/actions/hassfest@master

  release:
    name: Bump version and create release
    runs-on: ubuntu-latest
    needs: validate
    if: ${{ github.actor != 'github-actions[bot]' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Install uv and persist PATH
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Create virtual environment (uv venv)
        run: uv venv

      - name: Install runtime deps
        run: uv pip install -r requirements.txt

      - name: Ensure jq is available
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Determine version (use input or bump patch)
        id: get_version
        shell: bash
        run: |
          set -euo pipefail

          # Prefer explicit workflow_dispatch input if provided
          if [ -n "${{ github.event.inputs.version }}" ]; then
            version="${{ github.event.inputs.version }}"
          else
            current=$(jq -r '.version' custom_components/nexus_conversation/manifest.json)
            # parse MAJOR.MINOR.PATCH (fallback to 0.0.0)
            IFS='.' read -r MAJOR MINOR PATCH <<< "${current:-0.0.0}"
            PATCH=$((PATCH + 1))
            version="$MAJOR.$MINOR.$PATCH"
          fi

          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "Determined version: $version"

      - name: Update manifest.json with new version
        run: |
          jq --arg ver "${{ steps.get_version.outputs.version }}" '.version = $ver' custom_components/nexus_conversation/manifest.json > /tmp/manifest.json
          mv /tmp/manifest.json custom_components/nexus_conversation/manifest.json
          echo "Updated manifest.json to version ${{ steps.get_version.outputs.version }}"

      - name: Commit, tag and push
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          set -euo pipefail
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add custom_components/nexus_conversation/manifest.json
          # commit only if something changed
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update version to ${{ steps.get_version.outputs.version }}"
          fi

          # Use PAT to push
          git remote set-url origin https://x-access-token:${GH_PAT}@github.com/${{ github.repository }}.git

          # push branch (current HEAD). This will allow manifest change to be pushed on merge workflow runs as well.
          git push origin HEAD

          TAG="v${{ steps.get_version.outputs.version }}"
          # create tag only if it doesn't already exist
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists, skipping tag creation"
          else
            git tag "$TAG"
            git push origin "$TAG"
          fi

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GH_PAT }}
          name: "v${{ steps.get_version.outputs.version }}"
          tag: "v${{ steps.get_version.outputs.version }}"
          body: "Release v${{ steps.get_version.outputs.version }}"
          draft: false
          prerelease: false
          generateReleaseNotes: true
          allowUpdates: true
