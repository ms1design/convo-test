name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to set (optional). If not provided, the patch version will be incremented.'
        required: false
  # push:
  #   branches:
  #     - main

permissions:
  contents: write

jobs:
  validate:
    name: Validate HACS & hassfest
    runs-on: ubuntu-latest
    if: ${{ github.actor != 'github-actions[bot]' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Install dependencies
        run: uv install

      - name: HACS validation
        uses: hacs/action@main
        with:
          category: integration

      - name: Hassfest validation
        uses: home-assistant/actions/hassfest@master

  release:
    name: Bump version and create release
    runs-on: ubuntu-latest
    needs: validate
    if: ${{ github.actor != 'github-actions[bot]' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Install dependencies
        run: uv install

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Determine version
        id: get_version
        run: |
          if [ "${{ github.event.inputs.version }}" != "" ]; then
            version="${{ github.event.inputs.version }}"
          else
            version=$(jq -r '.version' custom_components/nexus_conversation/manifest.json)
            IFS='.' read -r major minor patch <<< "$version"
            patch=$((patch+1))
            version="$major.$minor.$patch"
          fi
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Update manifest.json
        run: |
          jq --arg ver "${{ steps.get_version.outputs.version }}" '.version = $ver' custom_components/nexus_conversation/manifest.json > manifest.tmp
          mv manifest.tmp custom_components/nexus_conversation/manifest.json

      - name: Commit and push changes
        run: |
          git config --global user.email "[emailÂ protected]"
          git config --global user.name "github-actions[bot]"
          git remote set-url origin "https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }}.git"
          git add custom_components/nexus_conversation/manifest.json
          git commit -m "Bump version to ${{ steps.get_version.outputs.version }}"
          git tag -a "${{ steps.get_version.outputs.version }}" -m "Release ${{ steps.get_version.outputs.version }}"
          git push origin HEAD
          git push origin "${{ steps.get_version.outputs.version }}"

      - name: Create GitHub release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          release_name: Release ${{ steps.get_version.outputs.version }}
          body: Release ${{ steps.get_version.outputs.version }}
